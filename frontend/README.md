#### You are on the improved search branch
Which is still underdevelopment

# Overview
The goal of this branch is to address issue #80, improving the search functionality, of dee2.
This will be achieved with:

 - [Elasticsearch](https://www.elastic.co/) to index the metadata generated by the dee2 pipeline.
 - Python (>=3.6) server running [aiohttp](https://docs.aiohttp.org/en/stable/) which will interface with Elasticseach
    using the provided client [package](https://elasticsearch-py.readthedocs.io/en/master/). In production
    this will sit behind the Apache server (requiring additional configuration).
 - [Elm](https://elm-lang.org/) will be used for the end user web UI. Hopefully this strictly typed checked
    language will help avoid unnecessary bugs.
 - [Bootstrap](https://getbootstrap.com/) Is used to streamline styling and design
 - [Parcel](https://parceljs.org/) is used to build Elm code into static files to be served.
     

# Setting up the development environment

- [Install](https://www.elastic.co/elasticsearch/?ultron=B-Stack-Trials-APJ-ANZ-Exact&gambit=Elasticsearch-install&blade=adwords-s&thor=install%20elasticsearch&gclid=CjwKCAjwoc_8BRAcEiwAzJevtU6L3dCJk-oDzUodHfZJwMW8L6nxFYBa9S6MR-LGmHewnPl4ds6oLRoCaLsQAvD_BwE) 
    Elasticsearch. The location of which may not matter in development, 
    however consideration will need to be made for production
    ###### Note: You may need to install Java
    
- [install](https://www.python.org/) Python (>=3.6)
- [install](https://elm-lang.org/) Elm (0.19)
- [install](https://parceljs.org/getting_started.html) Parcel

- #### Install dependencies for server.py
    Using a virtual environment is normally recommended 
    (however can be a pain having to constantly activate it).
    
    `$pip install aiohttp`
    
    `pip install aiohttp-devtools` - For auto reloading
    
    `$pip install elasticsearch`
    
- #### Run Elasticsearch
    On Windows this will be by running `elasticsearch.exe` found in
    `C:\Program Files\Elastic\Elasticsearch\7.9.2\bin` install location
    will vary depending on OS/install method (package manager/ tar.gz)
    
- #### Index the metadata files
    - Set the DEE2_METADATA_DIR environment variable to the location of the 
        `.tsv` files.
    - Run `ingest.py` script
        `python ingest.py` | `python3.6 ingest.py`. Expect this to take 5-6min 

- #### Start parcel watching for files changes.
    `$parcel watch index.html`
    
- #### Run the python server
    ###### Note: Activate the virtual environmet if using one
    
    `$python server.py` | `python3.6 server.py`

- Navigate to `http://localhost:8080/` in your browser

## To Uninstall Elm packages it is recommend to use [elm-json](https://github.com/zwilias/elm-json#removing-dependencies-elm-json-uninstall)

# Running Tests

 - Install [elm-spec](https://package.elm-lang.org/packages/brian-watkins/elm-spec/latest/) 
 
 - Install test runner `$npm install --save-dev elm-spec-runner
`
 - Run `$npx elm-spec` from dee2/frontend
    ###### Note: Dependencies in  `specs/elm.json` must
    ###### include all the dependencies in `elm.json`

## Other Useful Commands

#### Drop/Delete all indices in Elasticsearch

Windows Powershell
    
    $Invoke-WebRequest -method DELETE http://localhost:9200/_all

#### Start ElasticSearch (windows)
###### (must be on PATH)

    $elasticsearch.exe

#### Activate virtual environment (venv).

###### git-bash
   
    $. venv/Scrips/activate

###### (windows cmd)

    $"venv/Scripts/activate.bat"

#### Deactivate virtual environment (venv).
    $ deactivate
    
# Features under development

- Make Elasticsearch Http query available for reference.

- Search results should be downloadable with format options (tsv, csv, xls, ...)

- Filter results on species

# Deploy to production staging area 

## Install elastic search per instructions:

https://www.elastic.co/guide/en/elasticsearch/reference/current/deb.html

https://www.elastic.co/guide/en/elasticsearch/reference/current/starting-elasticsearch.html

   - Take note to install the version with only apache license
   - Use the correct start up instruction for systemd/init 
   
   ### Quick run down
   
   Download and install the public signing key
   
   `$ wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -`
   
   Add ElasticSearch to package list (This is for the Apache 2.0 license version)
   
   `$ echo "deb https://artifacts.elastic.co/packages/oss-7.x/apt stable main" | sudo tee /etc/apt/sources.list.d/elastic-7.x.list`
   
   Install with
   
   `$ sudo apt-get update && sudo apt-get install elasticsearch`
   
   Run as a service (systemd)
   
   ```
    $ sudo /bin/systemctl daemon-reload
    $ sudo /bin/systemctl enable elasticsearch.service
   ```
    
   Start and Stop with
   
   ```
   $ sudo systemctl start elasticsearch.service
   $ sudo systemctl stop elasticsearch.service
   ```
   Additional configuration:
   
   https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html

## Build static source files
    $ git clone https://github.com/markziemann/dee2
 
- Checkout improved_search branch

    `$ git checkout improved_search`
    
- Install python dependencies

    `$ pip3 install aiohttp`
    
    `$ pip3 install elasticsearch`
    
- Install Elm build tools 
    
    `$ npm install parcel-bundler`
    
- Build project in production mode

    `~/dee2/frontend$ parcel build improved_search.html`
    
- Copy generated static files into `/var/www/html`
    ###### assuming you cloned the git repo to your home directory
    `~/dee2/frontend$ sudo cp -r ~/dee2/frontend/dist/. /var/www/html`

###### You can git pull, parcel build and copy updated code as necessary

## Index DEE2 metadata into ElasticSearch

-   Ensure Elastic search is running (and configured to start as a service)

-   Set DEE2_METADATA_DIR environment variable
    ###### assuming you cloned the git repo to your home directory
    ```
    $ DEE2_METADATA_DIR=~/dee2/metadata
    $ export DEE2_METADATA_DIR
    ```
    
- Index the metadata
    
    `~/dee2/frontend$ python3 ingest.py`
    
## Run the python server

    ~/dee2/frontend$ python3 server.py
    
    
## Enable the site in Apache ...